import time

import torch as th
import syft as sy

# fmt: off
config_zoo = {
    "network1-mnist-128": {
        'fss_eq': [128],
        'fss_comp': [16384, 16384, 1280, 11520, 1280],
        'mul': [((128, 128), (128, 128)), ((128, 128), (128, 128)), ((128, 10), (128, 10))],
        'matmul': [((128, 784), (784, 128)), ((128, 128), (128, 128)), ((128, 128), (128, 10))]
    },
    "network2-mnist-128": {
        'fss_eq': [128],
        'fss_comp': [589824, 294912, 294912, 65536, 32768, 32768, 12800, 1280, 11520, 1280],
        'mul': [((128, 16, 144, 2), (128, 16, 144, 2)), ((128, 16, 144, 1), (128, 16, 144, 1)), ((128, 16, 12, 12), (128, 16, 12, 12)), ((128, 16, 16, 2), (128, 16, 16, 2)), ((128, 16, 16, 1), (128, 16, 16, 1)), ((128, 16, 4, 4), (128, 16, 4, 4)), ((128, 100), (128, 100)), ((128, 10), (128, 10))],
        'matmul': [((128, 576, 25), (25, 16)), ((128, 64, 400), (400, 16)), ((128, 256), (256, 100)), ((128, 100), (100, 10))]
    },
    "lenet-mnist-128": {
        'fss_eq': [128],
        'fss_comp': [737280, 368640, 368640, 204800, 102400, 102400, 64000, 1280, 11520, 1280],
        'mul': [((128, 20, 144, 2), (128, 20, 144, 2)), ((128, 20, 144, 1), (128, 20, 144, 1)), ((128, 20, 12, 12), (128, 20, 12, 12)), ((128, 50, 16, 2), (128, 50, 16, 2)), ((128, 50, 16, 1), (128, 50, 16, 1)), ((128, 50, 4, 4), (128, 50, 4, 4)), ((128, 500), (128, 500)), ((128, 10), (128, 10))],
        'matmul': [((128, 576, 25), (25, 20)), ((128, 64, 500), (500, 50)), ((128, 800), (800, 500)), ((128, 500), (500, 10))]
    },
    "alexnet-cifar10-128": {
        'fss_eq': [128],
        'fss_comp': [1228800, 614400, 307200, 307200, 307200, 131072, 65536, 32768, 32768, 32768, 49152, 49152, 32768, 32768, 32768, 1280, 11520, 1280],
        'mul': [((128, 96, 25, 4), (128, 96, 25, 4)), ((128, 96, 25, 2), (128, 96, 25, 2)), ((128, 96, 25, 1), (128, 96, 25, 1)), ((128, 96, 25, 1), (128, 96, 25, 1)), ((128, 96, 5, 5), (128, 96, 5, 5)), ((96,), (3200, 96)), ((3200, 96), (96,)), ((128, 256, 1, 4), (128, 256, 1, 4)), ((128, 256, 1, 2), (128, 256, 1, 2)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((256,), (128, 256)), ((128, 256), (256,)), ((128, 384, 1, 1), (128, 384, 1, 1)), ((128, 384, 1, 1), (128, 384, 1, 1)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((128, 256), (128, 256)), ((128, 256), (128, 256)), ((128, 10), (128, 10))],
        'matmul': [((128, 121, 363), (363, 96)), ((128, 9, 2400), (2400, 256)), ((128, 1, 2304), (2304, 384)), ((128, 1, 3456), (3456, 384)), ((128, 1, 3456), (3456, 256)), ((128, 256), (256, 256)), ((128, 256), (256, 256)), ((128, 256), (256, 10))]
    },
    "alexnet-tiny-imagenet-128": {
        'fss_eq': [128],
        'fss_comp': [1605632, 802816, 401408, 401408, 401408, 884736, 442368, 221184, 221184, 221184, 442368, 294912, 131072, 65536, 32768, 32768, 32768, 131072, 131072, 5094400, 25600],
        'mul': [((128, 64, 49, 4), (128, 64, 49, 4)), ((128, 64, 49, 2), (128, 64, 49, 2)), ((128, 64, 49, 1), (128, 64, 49, 1)), ((128, 64, 49, 1), (128, 64, 49, 1)), ((128, 64, 7, 7), (128, 64, 7, 7)), ((128, 192, 9, 4), (128, 192, 9, 4)), ((128, 192, 9, 2), (128, 192, 9, 2)), ((128, 192, 9, 1), (128, 192, 9, 1)), ((128, 192, 9, 1), (128, 192, 9, 1)), ((128, 192, 3, 3), (128, 192, 3, 3)), ((128, 384, 3, 3), (128, 384, 3, 3)), ((128, 256, 3, 3), (128, 256, 3, 3)), ((128, 256, 1, 4), (128, 256, 1, 4)), ((128, 256, 1, 2), (128, 256, 1, 2)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((128, 256, 1, 1), (128, 256, 1, 1)), ((128, 1024), (128, 1024)), ((128, 1024), (128, 1024))],
        'matmul': [((128, 225, 363), (363, 64)), ((128, 49, 1600), (1600, 192)), ((128, 9, 1728), (1728, 384)), ((128, 9, 3456), (3456, 256)), ((128, 9, 2304), (2304, 256)), ((128, 256), (256, 1024)), ((128, 1024), (1024, 1024)), ((128, 1024), (1024, 200))]
    },
    "vgg16-cifar10-1": {
        'fss_eq': [1],
        'fss_comp': [65536, 32768, 16384, 16384, 32768, 16384, 8192, 8192, 16384, 16384, 8192, 4096, 4096, 8192, 8192, 4096, 2048, 2048, 2048, 2048, 1024, 512, 512, 4096, 4096, 90, 10],
        'mul': [((1, 64, 32, 32), (1, 64, 32, 32)), ((1, 64, 256, 2), (1, 64, 256, 2)), ((1, 64, 256, 1), (1, 64, 256, 1)), ((1, 64, 16, 16), (1, 64, 16, 16)), ((1, 128, 16, 16), (1, 128, 16, 16)), ((1, 128, 64, 2), (1, 128, 64, 2)), ((1, 128, 64, 1), (1, 128, 64, 1)), ((1, 128, 8, 8), (1, 128, 8, 8)), ((1, 256, 8, 8), (1, 256, 8, 8)), ((1, 256, 8, 8), (1, 256, 8, 8)), ((1, 256, 16, 2), (1, 256, 16, 2)), ((1, 256, 16, 1), (1, 256, 16, 1)), ((1, 256, 4, 4), (1, 256, 4, 4)), ((1, 512, 4, 4), (1, 512, 4, 4)), ((1, 512, 4, 4), (1, 512, 4, 4)), ((1, 512, 4, 2), (1, 512, 4, 2)), ((1, 512, 4, 1), (1, 512, 4, 1)), ((1, 512, 2, 2), (1, 512, 2, 2)), ((1, 512, 2, 2), (1, 512, 2, 2)), ((1, 512, 2, 2), (1, 512, 2, 2)), ((1, 512, 1, 2), (1, 512, 1, 2)), ((1, 512, 1, 1), (1, 512, 1, 1)), ((1, 512, 1, 1), (1, 512, 1, 1)), ((1, 4096), (1, 4096)), ((1, 4096), (1, 4096))],
        'matmul': [((1, 1024, 27), (27, 64)), ((1, 1024, 576), (576, 64)), ((1, 256, 576), (576, 128)), ((1, 256, 1152), (1152, 128)), ((1, 64, 1152), (1152, 256)), ((1, 64, 2304), (2304, 256)), ((1, 64, 2304), (2304, 256)), ((1, 16, 2304), (2304, 512)), ((1, 16, 4608), (4608, 512)), ((1, 16, 4608), (4608, 512)), ((1, 4, 4608), (4608, 512)), ((1, 4, 4608), (4608, 512)), ((1, 4, 4608), (4608, 512)), ((1, 512), (512, 4096)), ((1, 4096), (4096, 4096)), ((1, 4096), (4096, 10))],
    },
    "vgg16-cifar10-64": {
        'fss_eq': [64],
        'fss_comp': [4194304, 2097152, 1048576, 1048576, 2097152, 1048576, 524288, 524288, 1048576, 1048576, 524288, 262144, 262144, 524288, 524288, 262144, 131072, 131072, 131072, 131072, 65536, 32768, 32768, 262144, 262144, 5760, 640],
        'mul': [((64, 64, 32, 32), (64, 64, 32, 32)), ((64, 64, 256, 2), (64, 64, 256, 2)), ((64, 64, 256, 1), (64, 64, 256, 1)), ((64, 64, 16, 16), (64, 64, 16, 16)), ((64, 128, 16, 16), (64, 128, 16, 16)), ((64, 128, 64, 2), (64, 128, 64, 2)), ((64, 128, 64, 1), (64, 128, 64, 1)), ((64, 128, 8, 8), (64, 128, 8, 8)), ((64, 256, 8, 8), (64, 256, 8, 8)), ((64, 256, 8, 8), (64, 256, 8, 8)), ((64, 256, 16, 2), (64, 256, 16, 2)), ((64, 256, 16, 1), (64, 256, 16, 1)), ((64, 256, 4, 4), (64, 256, 4, 4)), ((64, 512, 4, 4), (64, 512, 4, 4)), ((64, 512, 4, 4), (64, 512, 4, 4)), ((64, 512, 4, 2), (64, 512, 4, 2)), ((64, 512, 4, 1), (64, 512, 4, 1)), ((64, 512, 2, 2), (64, 512, 2, 2)), ((64, 512, 2, 2), (64, 512, 2, 2)), ((64, 512, 2, 2), (64, 512, 2, 2)), ((64, 512, 1, 2), (64, 512, 1, 2)), ((64, 512, 1, 1), (64, 512, 1, 1)), ((64, 512, 1, 1), (64, 512, 1, 1)), ((64, 4096), (64, 4096)), ((64, 4096), (64, 4096))],
        'matmul': [((64, 1024, 27), (27, 64)), ((64, 1024, 576), (576, 64)), ((64, 256, 576), (576, 128)), ((64, 256, 1152), (1152, 128)), ((64, 64, 1152), (1152, 256)), ((64, 64, 2304), (2304, 256)), ((64, 64, 2304), (2304, 256)), ((64, 16, 2304), (2304, 512)), ((64, 16, 4608), (4608, 512)), ((64, 16, 4608), (4608, 512)), ((64, 4, 4608), (4608, 512)), ((64, 4, 4608), (4608, 512)), ((64, 4, 4608), (4608, 512)), ((64, 512), (512, 4096)), ((64, 4096), (4096, 4096)), ((64, 4096), (4096, 10))]
    },
    "vgg16-cifar10-128": {
        'fss_eq': [128],
        'fss_comp': [8388608, 4194304, 2097152, 2097152, 4194304, 2097152, 1048576, 1048576, 2097152, 2097152, 1048576, 524288, 524288, 1048576, 1048576, 524288, 262144, 262144, 262144, 262144, 131072, 65536, 65536, 524288, 524288, 11520, 1280],
        'mul': [((128, 64, 32, 32), (128, 64, 32, 32)), ((128, 64, 256, 2), (128, 64, 256, 2)), ((128, 64, 256, 1), (128, 64, 256, 1)), ((128, 64, 16, 16), (128, 64, 16, 16)), ((128, 128, 16, 16), (128, 128, 16, 16)), ((128, 128, 64, 2), (128, 128, 64, 2)), ((128, 128, 64, 1), (128, 128, 64, 1)), ((128, 128, 8, 8), (128, 128, 8, 8)), ((128, 256, 8, 8), (128, 256, 8, 8)), ((128, 256, 8, 8), (128, 256, 8, 8)), ((128, 256, 16, 2), (128, 256, 16, 2)), ((128, 256, 16, 1), (128, 256, 16, 1)), ((128, 256, 4, 4), (128, 256, 4, 4)), ((128, 512, 4, 4), (128, 512, 4, 4)), ((128, 512, 4, 4), (128, 512, 4, 4)), ((128, 512, 4, 2), (128, 512, 4, 2)), ((128, 512, 4, 1), (128, 512, 4, 1)), ((128, 512, 2, 2), (128, 512, 2, 2)), ((128, 512, 2, 2), (128, 512, 2, 2)), ((128, 512, 2, 2), (128, 512, 2, 2)), ((128, 512, 1, 2), (128, 512, 1, 2)), ((128, 512, 1, 1), (128, 512, 1, 1)), ((128, 512, 1, 1), (128, 512, 1, 1)), ((128, 4096), (128, 4096)), ((128, 4096), (128, 4096))],
        'matmul': [((128, 1024, 27), (27, 64)), ((128, 1024, 576), (576, 64)), ((128, 256, 576), (576, 128)), ((128, 256, 1152), (1152, 128)), ((128, 64, 1152), (1152, 256)), ((128, 64, 2304), (2304, 256)), ((128, 64, 2304), (2304, 256)), ((128, 16, 2304), (2304, 512)), ((128, 16, 4608), (4608, 512)), ((128, 16, 4608), (4608, 512)), ((128, 4, 4608), (4608, 512)), ((128, 4, 4608), (4608, 512)), ((128, 4, 4608), (4608, 512)), ((128, 512), (512, 4096)), ((128, 4096), (4096, 4096)), ((128, 4096), (4096, 10))]
    },
    "vgg16-tiny-imagenet-1": {
        'fss_eq': [1],
        'fss_comp': [262144, 131072, 65536, 65536, 131072, 65536, 32768, 32768, 65536, 65536, 32768, 16384, 16384, 32768, 32768, 16384, 8192, 8192, 8192, 8192, 4096, 2048, 2048, 4096, 4096, 39800, 200],
        'mul': [((1, 64, 64, 64), (1, 64, 64, 64)), ((1, 64, 1024, 2), (1, 64, 1024, 2)), ((1, 64, 1024, 1), (1, 64, 1024, 1)), ((1, 64, 32, 32), (1, 64, 32, 32)), ((1, 128, 32, 32), (1, 128, 32, 32)), ((1, 128, 256, 2), (1, 128, 256, 2)), ((1, 128, 256, 1), (1, 128, 256, 1)), ((1, 128, 16, 16), (1, 128, 16, 16)), ((1, 256, 16, 16), (1, 256, 16, 16)), ((1, 256, 16, 16), (1, 256, 16, 16)), ((1, 256, 64, 2), (1, 256, 64, 2)), ((1, 256, 64, 1), (1, 256, 64, 1)), ((1, 256, 8, 8), (1, 256, 8, 8)), ((1, 512, 8, 8), (1, 512, 8, 8)), ((1, 512, 8, 8), (1, 512, 8, 8)), ((1, 512, 16, 2), (1, 512, 16, 2)), ((1, 512, 16, 1), (1, 512, 16, 1)), ((1, 512, 4, 4), (1, 512, 4, 4)), ((1, 512, 4, 4), (1, 512, 4, 4)), ((1, 512, 4, 4), (1, 512, 4, 4)), ((1, 512, 4, 2), (1, 512, 4, 2)), ((1, 512, 4, 1), (1, 512, 4, 1)), ((1, 512, 2, 2), (1, 512, 2, 2)), ((1, 4096), (1, 4096)), ((1, 4096), (1, 4096))],
        'matmul': [((1, 4096, 27), (27, 64)), ((1, 4096, 576), (576, 64)), ((1, 1024, 576), (576, 128)), ((1, 1024, 1152), (1152, 128)), ((1, 256, 1152), (1152, 256)), ((1, 256, 2304), (2304, 256)), ((1, 256, 2304), (2304, 256)), ((1, 64, 2304), (2304, 512)), ((1, 64, 4608), (4608, 512)), ((1, 64, 4608), (4608, 512)), ((1, 16, 4608), (4608, 512)), ((1, 16, 4608), (4608, 512)), ((1, 16, 4608), (4608, 512)), ((1, 2048), (2048, 4096)), ((1, 4096), (4096, 4096)), ((1, 4096), (4096, 200))],
    },
    "vgg16-tiny-imagenet-8": {
        'fss_eq': [8],
        'fss_comp': [2097152, 1048576, 524288, 524288, 1048576, 524288, 262144, 262144, 524288, 524288, 262144, 131072, 131072, 262144, 262144, 131072, 65536, 65536, 65536, 65536, 32768, 16384, 16384, 32768, 32768, 318400, 1600],
        'mul': [((8, 64, 64, 64), (8, 64, 64, 64)), ((8, 64, 1024, 2), (8, 64, 1024, 2)), ((8, 64, 1024, 1), (8, 64, 1024, 1)), ((8, 64, 32, 32), (8, 64, 32, 32)), ((8, 128, 32, 32), (8, 128, 32, 32)), ((8, 128, 256, 2), (8, 128, 256, 2)), ((8, 128, 256, 1), (8, 128, 256, 1)), ((8, 128, 16, 16), (8, 128, 16, 16)), ((8, 256, 16, 16), (8, 256, 16, 16)), ((8, 256, 16, 16), (8, 256, 16, 16)), ((8, 256, 64, 2), (8, 256, 64, 2)), ((8, 256, 64, 1), (8, 256, 64, 1)), ((8, 256, 8, 8), (8, 256, 8, 8)), ((8, 512, 8, 8), (8, 512, 8, 8)), ((8, 512, 8, 8), (8, 512, 8, 8)), ((8, 512, 16, 2), (8, 512, 16, 2)), ((8, 512, 16, 1), (8, 512, 16, 1)), ((8, 512, 4, 4), (8, 512, 4, 4)), ((8, 512, 4, 4), (8, 512, 4, 4)), ((8, 512, 4, 4), (8, 512, 4, 4)), ((8, 512, 4, 2), (8, 512, 4, 2)), ((8, 512, 4, 1), (8, 512, 4, 1)), ((8, 512, 2, 2), (8, 512, 2, 2)), ((8, 4096), (8, 4096)), ((8, 4096), (8, 4096))],
        'matmul': [((8, 4096, 27), (27, 64)), ((8, 4096, 576), (576, 64)), ((8, 1024, 576), (576, 128)), ((8, 1024, 1152), (1152, 128)), ((8, 256, 1152), (1152, 256)), ((8, 256, 2304), (2304, 256)), ((8, 256, 2304), (2304, 256)), ((8, 64, 2304), (2304, 512)), ((8, 64, 4608), (4608, 512)), ((8, 64, 4608), (4608, 512)), ((8, 16, 4608), (4608, 512)), ((8, 16, 4608), (4608, 512)), ((8, 16, 4608), (4608, 512)), ((8, 2048), (2048, 4096)), ((8, 4096), (4096, 4096)), ((8, 4096), (4096, 200))]
    },
    "vgg16-tiny-imagenet-16": {
        'fss_eq': [16],
        'fss_comp': [4194304, 2097152, 1048576, 1048576, 2097152, 1048576, 524288, 524288, 1048576, 1048576, 524288, 262144, 262144, 524288, 524288, 262144, 131072, 131072, 131072, 131072, 65536, 32768, 32768, 65536, 65536, 636800, 3200],
        'mul': [((16, 64, 64, 64), (16, 64, 64, 64)), ((16, 64, 1024, 2), (16, 64, 1024, 2)), ((16, 64, 1024, 1), (16, 64, 1024, 1)), ((16, 64, 32, 32), (16, 64, 32, 32)), ((16, 128, 32, 32), (16, 128, 32, 32)), ((16, 128, 256, 2), (16, 128, 256, 2)), ((16, 128, 256, 1), (16, 128, 256, 1)), ((16, 128, 16, 16), (16, 128, 16, 16)), ((16, 256, 16, 16), (16, 256, 16, 16)), ((16, 256, 16, 16), (16, 256, 16, 16)), ((16, 256, 64, 2), (16, 256, 64, 2)), ((16, 256, 64, 1), (16, 256, 64, 1)), ((16, 256, 8, 8), (16, 256, 8, 8)), ((16, 512, 8, 8), (16, 512, 8, 8)), ((16, 512, 8, 8), (16, 512, 8, 8)), ((16, 512, 16, 2), (16, 512, 16, 2)), ((16, 512, 16, 1), (16, 512, 16, 1)), ((16, 512, 4, 4), (16, 512, 4, 4)), ((16, 512, 4, 4), (16, 512, 4, 4)), ((16, 512, 4, 4), (16, 512, 4, 4)), ((16, 512, 4, 2), (16, 512, 4, 2)), ((16, 512, 4, 1), (16, 512, 4, 1)), ((16, 512, 2, 2), (16, 512, 2, 2)), ((16, 4096), (16, 4096)), ((16, 4096), (16, 4096))],
        'matmul': [((16, 4096, 27), (27, 64)), ((16, 4096, 576), (576, 64)), ((16, 1024, 576), (576, 128)), ((16, 1024, 1152), (1152, 128)), ((16, 256, 1152), (1152, 256)), ((16, 256, 2304), (2304, 256)), ((16, 256, 2304), (2304, 256)), ((16, 64, 2304), (2304, 512)), ((16, 64, 4608), (4608, 512)), ((16, 64, 4608), (4608, 512)), ((16, 16, 4608), (4608, 512)), ((16, 16, 4608), (4608, 512)), ((16, 16, 4608), (4608, 512)), ((16, 2048), (2048, 4096)), ((16, 4096), (4096, 4096)), ((16, 4096), (4096, 200))]
    },
    "vgg16-tiny-imagenet-32": {
        'fss_eq': [32],
        'fss_comp': [8388608, 4194304, 2097152, 2097152, 4194304, 2097152, 1048576, 1048576, 2097152, 2097152, 1048576, 524288, 524288, 1048576, 1048576, 524288, 262144, 262144, 262144, 262144, 131072, 65536, 65536, 131072, 131072, 1273600, 6400],
        'mul': [((32, 64, 64, 64), (32, 64, 64, 64)), ((32, 64, 1024, 2), (32, 64, 1024, 2)), ((32, 64, 1024, 1), (32, 64, 1024, 1)), ((32, 64, 32, 32), (32, 64, 32, 32)), ((32, 128, 32, 32), (32, 128, 32, 32)), ((32, 128, 256, 2), (32, 128, 256, 2)), ((32, 128, 256, 1), (32, 128, 256, 1)), ((32, 128, 16, 16), (32, 128, 16, 16)), ((32, 256, 16, 16), (32, 256, 16, 16)), ((32, 256, 16, 16), (32, 256, 16, 16)), ((32, 256, 64, 2), (32, 256, 64, 2)), ((32, 256, 64, 1), (32, 256, 64, 1)), ((32, 256, 8, 8), (32, 256, 8, 8)), ((32, 512, 8, 8), (32, 512, 8, 8)), ((32, 512, 8, 8), (32, 512, 8, 8)), ((32, 512, 16, 2), (32, 512, 16, 2)), ((32, 512, 16, 1), (32, 512, 16, 1)), ((32, 512, 4, 4), (32, 512, 4, 4)), ((32, 512, 4, 4), (32, 512, 4, 4)), ((32, 512, 4, 4), (32, 512, 4, 4)), ((32, 512, 4, 2), (32, 512, 4, 2)), ((32, 512, 4, 1), (32, 512, 4, 1)), ((32, 512, 2, 2), (32, 512, 2, 2)), ((32, 4096), (32, 4096)), ((32, 4096), (32, 4096))],
        'matmul': [((32, 4096, 27), (27, 64)), ((32, 4096, 576), (576, 64)), ((32, 1024, 576), (576, 128)), ((32, 1024, 1152), (1152, 128)), ((32, 256, 1152), (1152, 256)), ((32, 256, 2304), (2304, 256)), ((32, 256, 2304), (2304, 256)), ((32, 64, 2304), (2304, 512)), ((32, 64, 4608), (4608, 512)), ((32, 64, 4608), (4608, 512)), ((32, 16, 4608), (4608, 512)), ((32, 16, 4608), (4608, 512)), ((32, 16, 4608), (4608, 512)), ((32, 2048), (2048, 4096)), ((32, 4096), (4096, 4096)), ((32, 4096), (4096, 200))]
    },
    "resnet18-hymenoptera-1": {
        'fss_eq': [1],
        'fss_comp': [802816, 401408, 200704, 200704, 200704, 200704, 200704, 200704, 200704, 100352, 100352, 100352, 100352, 50176, 50176, 50176, 50176, 25088, 25088, 25088, 25088, 2, 2],
        'mul': [((64,), (12544, 64)), ((12544, 64), (64,)), ((1, 64, 3136, 4), (1, 64, 3136, 4)), ((1, 64, 3136, 2), (1, 64, 3136, 2)), ((1, 64, 3136, 1), (1, 64, 3136, 1)), ((1, 64, 3136, 1), (1, 64, 3136, 1)), ((1, 64, 56, 56), (1, 64, 56, 56)), ((64,), (3136, 64)), ((3136, 64), (64,)), ((1, 64, 56, 56), (1, 64, 56, 56)), ((64,), (3136, 64)), ((3136, 64), (64,)), ((1, 64, 56, 56), (1, 64, 56, 56)), ((64,), (3136, 64)), ((3136, 64), (64,)), ((1, 64, 56, 56), (1, 64, 56, 56)), ((64,), (3136, 64)), ((3136, 64), (64,)), ((1, 64, 56, 56), (1, 64, 56, 56)), ((128,), (784, 128)), ((784, 128), (128,)), ((1, 128, 28, 28), (1, 128, 28, 28)), ((128,), (784, 128)), ((784, 128), (128,)), ((128,), (784, 128)), ((784, 128), (128,)), ((1, 128, 28, 28), (1, 128, 28, 28)), ((128,), (784, 128)), ((784, 128), (128,)), ((1, 128, 28, 28), (1, 128, 28, 28)), ((128,), (784, 128)), ((784, 128), (128,)), ((1, 128, 28, 28), (1, 128, 28, 28)), ((256,), (196, 256)), ((196, 256), (256,)), ((1, 256, 14, 14), (1, 256, 14, 14)), ((256,), (196, 256)), ((196, 256), (256,)), ((256,), (196, 256)), ((196, 256), (256,)), ((1, 256, 14, 14), (1, 256, 14, 14)), ((256,), (196, 256)), ((196, 256), (256,)), ((1, 256, 14, 14), (1, 256, 14, 14)), ((256,), (196, 256)), ((196, 256), (256,)), ((1, 256, 14, 14), (1, 256, 14, 14)), ((512,), (49, 512)), ((49, 512), (512,)), ((1, 512, 7, 7), (1, 512, 7, 7)), ((512,), (49, 512)), ((49, 512), (512,)), ((512,), (49, 512)), ((49, 512), (512,)), ((1, 512, 7, 7), (1, 512, 7, 7)), ((512,), (49, 512)), ((49, 512), (512,)), ((1, 512, 7, 7), (1, 512, 7, 7)), ((512,), (49, 512)), ((49, 512), (512,)), ((1, 512, 7, 7), (1, 512, 7, 7))],
        'matmul': [((1, 12544, 147), (147, 64)), ((1, 3136, 576), (576, 64)), ((1, 3136, 576), (576, 64)), ((1, 3136, 576), (576, 64)), ((1, 3136, 576), (576, 64)), ((1, 784, 576), (576, 128)), ((1, 784, 1152), (1152, 128)), ((1, 784, 64), (64, 128)), ((1, 784, 1152), (1152, 128)), ((1, 784, 1152), (1152, 128)), ((1, 196, 1152), (1152, 256)), ((1, 196, 2304), (2304, 256)), ((1, 196, 128), (128, 256)), ((1, 196, 2304), (2304, 256)), ((1, 196, 2304), (2304, 256)), ((1, 49, 2304), (2304, 512)), ((1, 49, 4608), (4608, 512)), ((1, 49, 256), (256, 512)), ((1, 49, 4608), (4608, 512)), ((1, 49, 4608), (4608, 512)), ((1, 512), (512, 2))]
    },
    "resnet18-hymenoptera-4": {
        'fss_eq': [4],
        'fss_comp': [3211264, 1605632, 802816, 802816, 802816, 802816, 802816, 802816, 802816, 401408, 401408, 401408, 401408, 200704, 200704, 200704, 200704, 100352, 100352, 100352, 100352, 8, 8],
        'mul': [((64,), (50176, 64)), ((50176, 64), (64,)), ((4, 64, 3136, 4), (4, 64, 3136, 4)), ((4, 64, 3136, 2), (4, 64, 3136, 2)), ((4, 64, 3136, 1), (4, 64, 3136, 1)), ((4, 64, 3136, 1), (4, 64, 3136, 1)), ((4, 64, 56, 56), (4, 64, 56, 56)), ((64,), (12544, 64)), ((12544, 64), (64,)), ((4, 64, 56, 56), (4, 64, 56, 56)), ((64,), (12544, 64)), ((12544, 64), (64,)), ((4, 64, 56, 56), (4, 64, 56, 56)), ((64,), (12544, 64)), ((12544, 64), (64,)), ((4, 64, 56, 56), (4, 64, 56, 56)), ((64,), (12544, 64)), ((12544, 64), (64,)), ((4, 64, 56, 56), (4, 64, 56, 56)), ((128,), (3136, 128)), ((3136, 128), (128,)), ((4, 128, 28, 28), (4, 128, 28, 28)), ((128,), (3136, 128)), ((3136, 128), (128,)), ((128,), (3136, 128)), ((3136, 128), (128,)), ((4, 128, 28, 28), (4, 128, 28, 28)), ((128,), (3136, 128)), ((3136, 128), (128,)), ((4, 128, 28, 28), (4, 128, 28, 28)), ((128,), (3136, 128)), ((3136, 128), (128,)), ((4, 128, 28, 28), (4, 128, 28, 28)), ((256,), (784, 256)), ((784, 256), (256,)), ((4, 256, 14, 14), (4, 256, 14, 14)), ((256,), (784, 256)), ((784, 256), (256,)), ((256,), (784, 256)), ((784, 256), (256,)), ((4, 256, 14, 14), (4, 256, 14, 14)), ((256,), (784, 256)), ((784, 256), (256,)), ((4, 256, 14, 14), (4, 256, 14, 14)), ((256,), (784, 256)), ((784, 256), (256,)), ((4, 256, 14, 14), (4, 256, 14, 14)), ((512,), (196, 512)), ((196, 512), (512,)), ((4, 512, 7, 7), (4, 512, 7, 7)), ((512,), (196, 512)), ((196, 512), (512,)), ((512,), (196, 512)), ((196, 512), (512,)), ((4, 512, 7, 7), (4, 512, 7, 7)), ((512,), (196, 512)), ((196, 512), (512,)), ((4, 512, 7, 7), (4, 512, 7, 7)), ((512,), (196, 512)), ((196, 512), (512,)), ((4, 512, 7, 7), (4, 512, 7, 7))],
        'matmul': [((4, 12544, 147), (147, 64)), ((4, 3136, 576), (576, 64)), ((4, 3136, 576), (576, 64)), ((4, 3136, 576), (576, 64)), ((4, 3136, 576), (576, 64)), ((4, 784, 576), (576, 128)), ((4, 784, 1152), (1152, 128)), ((4, 784, 64), (64, 128)), ((4, 784, 1152), (1152, 128)), ((4, 784, 1152), (1152, 128)), ((4, 196, 1152), (1152, 256)), ((4, 196, 2304), (2304, 256)), ((4, 196, 128), (128, 256)), ((4, 196, 2304), (2304, 256)), ((4, 196, 2304), (2304, 256)), ((4, 49, 2304), (2304, 512)), ((4, 49, 4608), (4608, 512)), ((4, 49, 256), (256, 512)), ((4, 49, 4608), (4608, 512)), ((4, 49, 4608), (4608, 512)), ((4, 512), (512, 2))]
    },
    "resnet18-hymenoptera-8": {
        'fss_eq': [8],
        'fss_comp': [6422528, 3211264, 1605632, 1605632, 1605632, 1605632, 1605632, 1605632, 1605632, 802816, 802816, 802816, 802816, 401408, 401408, 401408, 401408, 200704, 200704, 200704, 200704, 16, 16],
        'mul': [((64,), (100352, 64)), ((100352, 64), (64,)), ((8, 64, 3136, 4), (8, 64, 3136, 4)), ((8, 64, 3136, 2), (8, 64, 3136, 2)), ((8, 64, 3136, 1), (8, 64, 3136, 1)), ((8, 64, 3136, 1), (8, 64, 3136, 1)), ((8, 64, 56, 56), (8, 64, 56, 56)), ((64,), (25088, 64)), ((25088, 64), (64,)), ((8, 64, 56, 56), (8, 64, 56, 56)), ((64,), (25088, 64)), ((25088, 64), (64,)), ((8, 64, 56, 56), (8, 64, 56, 56)), ((64,), (25088, 64)), ((25088, 64), (64,)), ((8, 64, 56, 56), (8, 64, 56, 56)), ((64,), (25088, 64)), ((25088, 64), (64,)), ((8, 64, 56, 56), (8, 64, 56, 56)), ((128,), (6272, 128)), ((6272, 128), (128,)), ((8, 128, 28, 28), (8, 128, 28, 28)), ((128,), (6272, 128)), ((6272, 128), (128,)), ((128,), (6272, 128)), ((6272, 128), (128,)), ((8, 128, 28, 28), (8, 128, 28, 28)), ((128,), (6272, 128)), ((6272, 128), (128,)), ((8, 128, 28, 28), (8, 128, 28, 28)), ((128,), (6272, 128)), ((6272, 128), (128,)), ((8, 128, 28, 28), (8, 128, 28, 28)), ((256,), (1568, 256)), ((1568, 256), (256,)), ((8, 256, 14, 14), (8, 256, 14, 14)), ((256,), (1568, 256)), ((1568, 256), (256,)), ((256,), (1568, 256)), ((1568, 256), (256,)), ((8, 256, 14, 14), (8, 256, 14, 14)), ((256,), (1568, 256)), ((1568, 256), (256,)), ((8, 256, 14, 14), (8, 256, 14, 14)), ((256,), (1568, 256)), ((1568, 256), (256,)), ((8, 256, 14, 14), (8, 256, 14, 14)), ((512,), (392, 512)), ((392, 512), (512,)), ((8, 512, 7, 7), (8, 512, 7, 7)), ((512,), (392, 512)), ((392, 512), (512,)), ((512,), (392, 512)), ((392, 512), (512,)), ((8, 512, 7, 7), (8, 512, 7, 7)), ((512,), (392, 512)), ((392, 512), (512,)), ((8, 512, 7, 7), (8, 512, 7, 7)), ((512,), (392, 512)), ((392, 512), (512,)), ((8, 512, 7, 7), (8, 512, 7, 7))],
        'matmul': [((8, 12544, 147), (147, 64)), ((8, 3136, 576), (576, 64)), ((8, 3136, 576), (576, 64)), ((8, 3136, 576), (576, 64)), ((8, 3136, 576), (576, 64)), ((8, 784, 576), (576, 128)), ((8, 784, 1152), (1152, 128)), ((8, 784, 64), (64, 128)), ((8, 784, 1152), (1152, 128)), ((8, 784, 1152), (1152, 128)), ((8, 196, 1152), (1152, 256)), ((8, 196, 2304), (2304, 256)), ((8, 196, 128), (128, 256)), ((8, 196, 2304), (2304, 256)), ((8, 196, 2304), (2304, 256)), ((8, 49, 2304), (2304, 512)), ((8, 49, 4608), (4608, 512)), ((8, 49, 256), (256, 512)), ((8, 49, 4608), (4608, 512)), ((8, 49, 4608), (4608, 512)), ((8, 512), (512, 2))]
    }
}
# fmt: on


def build_prepocessing(model, dataset, batch_size, workers, args):
    start_time = time.time()

    try:
        config = config_zoo[f"{model}-{dataset}-{batch_size}"]
    except KeyError:
        print(f"WARNING: No preprocessing found for {model}-{dataset}-{batch_size}")
        return 0

    if args.verbose:
        print("Preprocess")

    for op in ["fss_eq", "fss_comp"]:
        n_instances_list = config[op]
        for n_instances in n_instances_list:
            if args.verbose:
                print(f"{op} n_instances", n_instances)
            sy.local_worker.crypto_store.provide_primitives(
                op=op, workers=workers, n_instances=n_instances
            )

    for op in ["mul", "matmul"]:
        if args.dtype == "int":
            torch_dtype = th.int32
            field = 2 ** 32
        elif args.dtype == "long":
            torch_dtype = th.int64
            field = 2 ** 64
        else:
            raise ValueError(f"Unsupported dtype {args.dtype}")

        shapes = config[op]
        if args.verbose:
            print(f"{op} shapes", shapes)
        sy.local_worker.crypto_store.provide_primitives(
            op=op,
            workers=workers,
            n_instances=1,
            shapes=shapes,
            dtype=args.dtype,
            torch_dtype=torch_dtype,
            field=field,
        )

    preprocess_time = time.time() - start_time
    if args.verbose:
        print(
            "...", preprocess_time, "s", "[time per item=", preprocess_time / args.batch_size, "]"
        )
    else:
        print("Preprocessing time (s):\t", round(preprocess_time / args.batch_size, 4))
    return preprocess_time
