
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Advanced Deployment: Introduction to HaGrid &#8212; PySyft  documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/pysyft.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../getting_started/index.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api_reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../developer_guide/index.html">
  Contributor Guidelines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="glossary.html">
  Glossary
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../resources/index.html">
  Resources
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../guides/index.html">
  How-to Guides
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/OpenMined/PySyft" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/openminedorg" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-virtual-environment-using-python-3-9">
     Setting up virtual environment using Python 3.9
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-latest-pip">
     Using latest pip
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-jupyter-notebook">
     Install Jupyter Notebook
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#installing-and-configuring-docker">
     Installing and configuring Docker
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#explore-locally-with-the-pysyft-api">
   Explore locally with the PySyft API
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-deployment-using-docker">
   Local deployment using Docker
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-deployment-using-vagrant-and-virtualbox">
   Local deployment using Vagrant and VirtualBox
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-on-kubernetes">
   Deploying on Kubernetes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#macos">
     MacOS
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-to-local-dev">
     Deploy to local dev
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-to-google-kubernetes-engine-gke">
     Deploy to Google Kubernetes Engine (GKE)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-to-azure">
   Deploying to Azure
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="advanced-deployment-introduction-to-hagrid">
<span id="advanced-deployment"></span><h1>Advanced Deployment: Introduction to HaGrid<a class="headerlink" href="#advanced-deployment-introduction-to-hagrid" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>Hagrid (HAppy GRID!) is a command-line tool that speeds up the
deployment of PyGrid, the software providing a peer-to-peer network of
data owners and data scientists who can collectively train AI models
using <a class="reference external" href="https://github.com/OpenMined/PySyft/">PySyft</a>.</p>
<p>Hagrid is able to orchestrate a collection of PyGrid Domain and Network
nodes and scale them in a local development environment (based on a
docker-compose file). By stacking multiple copies of this docker, you
can simulate multiple entities (e.g countries) that collaborate over
data and experiment with more complicated data flows such as SMPC.</p>
<p>Similarly to the local deployment, Hagrid can bootstrap docker on a
Vagrant VM or on a cloud VM, helping you deploy in an user-friendly way
on Azure, AWS* and GCP*.</p>
<p><em>* Deploying to AWS and GCP is still under development.</em></p>
<p>Working with Hagrid &amp; Syft API versions:</p>
<ul class="simple">
<li><dl class="simple">
<dt><strong>Development mode:</strong></dt><dd><p>You can experiment with your own local checked-out version of Syft
and bootstrap a local Jupyter Notebook where you can use the Syft
&amp; Grid API to communicate with a prod/local dev system<em>.</em></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Production mode:</strong></dt><dd><p>You can specify the branch and repository you want to fork (including your own fork) and Hagrid will monitor those branches in a cron job, pull new changes and restart the services to apply them, therefore your deployed system will always stay up to date.</p>
</dd>
</dl>
</li>
</ul>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>The following operating systems are currently supported: Linux, Windows, MacOS. Please ensure you have at least 8GB of ram if you intend to run Hagrid locally.</p>
<section id="setting-up-virtual-environment-using-python-3-9">
<h3>Setting up virtual environment using Python 3.9<a class="headerlink" href="#setting-up-virtual-environment-using-python-3-9" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Ensure using <strong>Python3.8+</strong>, which should be first installed in your system. To easily handle further dependencies, we suggest using conda:</p>
<ol class="loweralpha">
<li><p>Install conda <a class="reference external" href="https://docs.anaconda.com/anaconda/install/index.html/">following these instructions</a>  depending on your OS.</p></li>
<li><p>Create a new env specifying the Python version (we recommend Python 3.8/3.9) in the terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda create -n myenv <span class="nv">python</span><span class="o">=</span><span class="m">3</span>.9
$ conda activate myenv
<span class="o">(</span>to <span class="nb">exit</span><span class="o">)</span>: conda deactivate
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
</section>
<section id="using-latest-pip">
<h3>Using latest pip<a class="headerlink" href="#using-latest-pip" title="Permalink to this headline">¶</a></h3>
<p><strong>Pip</strong> is required to install dependencies, so make sure you have it installed and up-to-date by running the following these <a class="reference external" href="https://pip.pypa.io/en/stable/installation/#supported-methods/">instructions</a>.</p>
<p>If you have it installed, please check it is the latest version:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install --upgrade pip <span class="o">&amp;&amp;</span> pip -V <span class="o">(</span>Linux<span class="o">)</span>
$ python -m pip install --upgrade pip <span class="o">(</span><span class="k">for</span> Windows<span class="o">)</span>
</pre></div>
</div>
</section>
<section id="install-jupyter-notebook">
<h3>Install Jupyter Notebook<a class="headerlink" href="#install-jupyter-notebook" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>A very convenient way to interact with a deployed node is via Python, using a Jupyter Notebook. You can install it by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install jupyter-notebook
</pre></div>
</div>
</li>
<li><p>If you encounter issues, you can also install it using Conda:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda install -c conda-forge notebook
</pre></div>
</div>
</li>
<li><p>To launch the Jupyter Notebook, you can run the following in your terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ jupyter notebook
</pre></div>
</div>
</li>
</ol>
</section>
<section id="installing-and-configuring-docker">
<h3>Installing and configuring Docker<a class="headerlink" href="#installing-and-configuring-docker" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Install <strong>Docker</strong> and <strong>Docker Composite V2,</strong> which is needed to orchestrate docker, as explained below:</p>
<p>For <strong>Linux</strong>:</p>
<ol class="loweralpha">
<li><p>Install <strong>Docker</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade docker <span class="p">&amp;</span> docker run hello-world
</pre></div>
</div>
</li>
<li><p>Install <strong>Docker Composite V2</strong> as described <a class="reference external" href="https://docs.docker.com/compose/cli-command/#installing-compose-v2">here</a>.</p></li>
<li><p>You should see ‘Docker Compose version v2’ when running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker compose version
</pre></div>
</div>
</li>
<li><p>If not, go through the <a class="reference external" href="https://www.rockyourcode.com/how-to-install-docker-compose-v2-on-linux-2021/">instructions here</a> or if you are using Linux, you can try to do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mkdir -p ~/.docker/cli-plugins
$ curl -sSL https://github.com/docker/compose-cli/releases/download/v2.0.0-beta.5/docker-compose-linux-amd64 -o ~/.docker/cli-plugins/docker-compose
$ chmod +x ~/.docker/cli-plugins/docker-compose
</pre></div>
</div>
</li>
<li><p>Also, make sure you can run without sudo:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="nv">$USER</span> //<span class="o">(</span>should <span class="k">return</span> your username<span class="o">)</span>
$ sudo usermod -aG docker <span class="nv">$USER</span>
</pre></div>
</div>
</li>
</ol>
<p>For <strong>Windows</strong>, <strong>MacOs</strong>:</p>
<ol class="loweralpha simple">
<li><p>You can install Desktop Docker as explained <a class="reference external" href="https://docs.docker.com/docker-for-windows/install/">here for Windows</a> or <a class="reference external" href="https://docs.docker.com/docker-for-mac/install/">here for MacOS</a>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">docker-compose</span></code> should be enabled by default. If you encounter issues, you can check it by:</p>
<ul class="simple">
<li><p>Go to the Docker menu, click <code class="docutils literal notranslate"><span class="pre">Preferences</span> <span class="pre">(Settings</span> <span class="pre">on</span> <span class="pre">Windows)</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">Experimental</span> <span class="pre">features</span></code>.</p></li>
<li><p>Make sure the Use <code class="docutils literal notranslate"><span class="pre">Docker</span> <span class="pre">Compose</span> <span class="pre">V2</span></code> box is checked.</p></li>
</ul>
</li>
<li><p>Ensure at least 8GB of RAM are allocated in the Desktop Docker app:</p>
<ul class="simple">
<li><p>Go to ‘Preferences’ -&gt; ‘Resources’</p></li>
<li><p>Drag the ‘Memory’ dot until it says at least 8.00GB</p></li>
<li><p>Click ‘Apply &amp; Restart’</p></li>
</ul>
</li>
</ol>
</li>
<li><p>Make sure you are using the <strong>dev</strong> branch of the PySyft repository (branch can be found <a class="reference external" href="https://github.com/OpenMined/PySyft/tree/0.6.0">here</a>)</p></li>
</ol>
</section>
</section>
<section id="explore-locally-with-the-pysyft-api">
<h2>Explore locally with the PySyft API<a class="headerlink" href="#explore-locally-with-the-pysyft-api" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Install <strong>tox</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install tox
</pre></div>
</div>
</li>
<li><p>Move to the correct branch in the PySyft repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git checkout dev
</pre></div>
</div>
</li>
<li><p>Check current tasks that can be run by tox:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tox -l
</pre></div>
</div>
</li>
<li><p>Open an editable Jupyter Notebook which doesn’t require to run in a container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tox -e syft.jupyter
</pre></div>
</div>
</li>
</ol>
</section>
<section id="local-deployment-using-docker">
<h2>Local deployment using Docker<a class="headerlink" href="#local-deployment-using-docker" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Install Hagrid:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install -U hagrid
</pre></div>
</div>
</li>
<li><p>Launch a Domain Node:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ hagrid launch domain
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>First run <strong>it might take ~5-10 mins</strong> to build the PyGrid docker image. Afterwards, you should see something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Launching a domaing PyGrid node on port <span class="m">8081</span> !

- TYPE: domain
- NAME: mystifying_wolf
- TAG: 035c3b6a378a50f78cd74fc641d863c7
- PORT: <span class="m">8081</span>
- DOCKER: v2.2.3
</pre></div>
</div>
</div>
<p>Optionally, you can provide here additional args to use a certain repository and branch, as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ hagrid launch domain --repo <span class="nv">$REPO</span> --branch <span class="nv">$BRANCH</span>
</pre></div>
</div>
</li>
<li><p>Go to <code class="docutils literal notranslate"><span class="pre">localhost:port/login</span></code> in your browser (using the port specified in your CLI, here <em>8081</em>) to see the PyGrid Admin UI where you, as a data owner, can manage your PyGrid deployment.</p>
<ol class="loweralpha">
<li><p>Log in using the following credentials:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">info</span><span class="nd">@openmined</span><span class="o">.</span><span class="n">org</span>

<span class="n">changethis</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Explore the interface or you can even do requests via <a class="reference external" href="https://www.postman.com/downloads/">Postman</a>. You can check all the available endpoints at <a class="reference external" href="http://localhost:8081/api/v1/openapi.json/">http://localhost:8081/api/v1/openapi.json/</a> and have all the following environment variables set (a more detailed explanationcan be found in <a class="reference external" href="https://youtu.be/GCw7cN7xXJU?t=442">this video section</a>):</p>
<p><a class="reference internal" href="../_images/image2.png"><img alt="image0" src="../_images/image2.png" style="width: 95%;" /></a></p>
<p>The auth token can be obtained by doing a login request as follows:</p>
<p><a class="reference internal" href="../_images/image1.png"><img alt="image1" src="../_images/image1.png" style="width: 95%;" /></a></p>
</li>
</ol>
</li>
<li><p>While the Domain Node is online, you can start a Jupyter Notebook as described <a class="reference external" href="#explore-locally-with-the-pysyft-api-no-containers-involved">above</a> to use PySyft to communicate to it in a Python client rather than a REST API. Connecting to it can be done as following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">syft</span> <span class="k">as</span> <span class="nn">sy</span>

<span class="n">domain</span> <span class="o">=</span> <span class="n">sy</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;info@openmined.org&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;changethis&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8081</span><span class="p">)</span>

<span class="n">domain</span><span class="o">.</span><span class="n">store</span>

<span class="n">domain</span><span class="o">.</span><span class="n">requests</span>

<span class="n">Domain</span><span class="o">.</span><span class="n">users</span>
</pre></div>
</div>
</li>
<li><p>To stop the node, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ hagrid land --tag<span class="o">=</span>035c3b6a378a50f78cd74fc641d863c7 <span class="o">(</span>using the TAG specified <span class="k">in</span> your CLI<span class="o">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="local-deployment-using-vagrant-and-virtualbox">
<h2>Local deployment using Vagrant and VirtualBox<a class="headerlink" href="#local-deployment-using-vagrant-and-virtualbox" title="Permalink to this headline">¶</a></h2>
<p>This is particularly useful to experiment with the Ansible scripts to test new changes.</p>
<ol class="arabic">
<li><p>Run hagrid status and ensure all dependencies are checked to make sure you have Vagrant and VirtualBox installed.</p>
<p><a class="reference internal" href="../_images/image3.png"><img alt="image2" src="../_images/image3.png" style="width: 95%;" /></a></p>
</li>
<li><p>For installing Vagrant, check the <a class="reference external" href="https://www.vagrantup.com/downloads">instructions here.</a></p></li>
<li><p>Additionally to Vagrant, we need to install a plugin called landrush that allows using a custom DNS that points to the IP address used in the VM:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vagrant plugin install landrush
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="3">
<li><p>Move to the correct branch and directory in the PySyft repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git checkout <span class="m">0</span>.6.0
$ <span class="nb">cd</span> packages/grid
</pre></div>
</div>
</li>
<li><p>Create the environment using vagrant for the first time:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vagrant init
$ vagrant up
</pre></div>
</div>
<p>When the VM is booted up, it starts the docker service and then the docker service starts all the containers as configured. As it is just created, provisioning is always <strong>run</strong> automatically<strong>.</strong></p>
<p>When deploying locally, the tasks listed in ‘main.yml’ for the node are not being run. Therefore, it does not have to do the lengthy
setup every time (installing docker, cloning PySyft and launching the cronjob to reload PySyft).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The tasks for the containers and nodes respectively can be found in *.yml files defined in <code class="docutils literal notranslate"><span class="pre">packages/grid/ansible/roles/containers</span></code> and <code class="docutils literal notranslate"><span class="pre">packages/grid/ansible/roles/nodes</span></code></p>
</div>
</li>
<li><p>If you intend to run it frequently and not only once, either run <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">status</span></code> to see if the env has already been created and if yes, to <code class="docutils literal notranslate"><span class="pre">run</span> <span class="pre">vagrant</span> <span class="pre">up</span> <span class="pre">--provision</span></code> every time to launch the provisioners, otherwise it is just resuming the existing machine.</p></li>
<li><p>To access the VM via SSh and jump to the user we are creating in vagrant:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vagrant ssh
$ sudo su -om
$ whoami <span class="c1"># should return &#39;om&#39;</span>
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="8">
<li><dl class="simple">
<dt>You can go to <code class="docutils literal notranslate"><span class="pre">http://10.0.1.2/login</span></code> which is at port 80 to access the PyGrid Admin UI, which you can explore, query via Postman or in a</dt><dd><p>local Jupyter Notebook using a Python client as described in <a class="reference external" href="#local-deployment-using-docker">steps 3 and 4 here</a>.</p>
</dd>
</dl>
</li>
<li><p>To shut down the machine currently managed by Vagrant, you can run the following after exiting this node shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vagrant halt
</pre></div>
</div>
</li>
<li><p>Or alternatively to destroy it using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vagrant destroy
</pre></div>
</div>
</li>
</ol>
</section>
<section id="deploying-on-kubernetes">
<h2>Deploying on Kubernetes<a class="headerlink" href="#deploying-on-kubernetes" title="Permalink to this headline">¶</a></h2>
<p>We provide an option to deploy the stack using kubernetes. To test and run this locally we use <code class="docutils literal notranslate"><span class="pre">minikube</span></code> and <code class="docutils literal notranslate"><span class="pre">devspace</span></code>.</p>
<p>These are the prerequisites needed further, which are explained step-by-step below:</p>
<ul class="simple">
<li><p>docker</p></li>
<li><p>hyperkit</p></li>
<li><p>minikube</p></li>
<li><p>devspace</p></li>
<li><p>kubectl</p></li>
<li><p>kubectx</p></li>
</ul>
<section id="macos">
<h3>MacOS<a class="headerlink" href="#macos" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>Hyperkit</strong></p></li>
</ul>
<p>Ingress is not working on Mac and Docker and the issue is <a class="reference external" href="https://github.com/kubernetes/minikube/issues/7332">being tracked here</a>. Until then we will use the <code class="docutils literal notranslate"><span class="pre">hyperkit</span></code> backend.</p>
<ol class="arabic simple">
<li><p>Install hyperkit by running:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ brew install hyperkit
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Docker</strong></p></li>
</ul>
<ol class="arabic simple">
<li><p>See above about using <code class="docutils literal notranslate"><span class="pre">hyperkit</span></code> on Mac until the ingress issue is fixed.</p></li>
<li><p>We will be using Docker - however you do not need to <code class="docutils literal notranslate"><span class="pre">enable</span> <span class="pre">kubernetes</span></code> in your Docker Desktop App. If it is enabled, disable it and click <cite>Apply &amp; Restart</cite>.</p></li>
<li><p>This is because we will use <code class="docutils literal notranslate"><span class="pre">minikube</span></code> which will create and manage all the k8s resources we require as a normal container in docker engine. We install it by running:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ brew install minikube
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Minikube</strong></p></li>
</ul>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minikube</span></code> is a mini master k8s node that you can run on your local machine in a similar manner to Docker. To use minikube you need it to be running:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ minikube config <span class="nb">set</span> driver hyperkit
$ minikube start --disk-size<span class="o">=</span>40g
$ minikube addons <span class="nb">enable</span> ingress
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>If you ever need to reset <code class="docutils literal notranslate"><span class="pre">minikube</span></code> you can do:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ minikube delete --all --purge
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Once <code class="docutils literal notranslate"><span class="pre">minikube</span></code> is running, you should see the container in Docker by running:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker ps
CONTAINER ID   IMAGE                                 COMMAND                  CREATED        STATUS              PORTS                                                                                                                                  NAMES
57f73851bf08   gcr.io/k8s-minikube/kicbase:v0.0.25   <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="m">46</span> hours ago   Up About a minute   <span class="m">127</span>.0.0.1:57954-&gt;22/tcp, <span class="m">127</span>.0.0.1:57955-&gt;2376/tcp, <span class="m">127</span>.0.0.1:57957-&gt;5000/tcp, <span class="m">127</span>.0.0.1:57958-&gt;8443/tcp, <span class="m">127</span>.0.0.1:57956-&gt;32443/tcp minikube
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Kubectl</strong></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span></code> is the CLI tool for kubernetes. If you have ran <code class="docutils literal notranslate"><span class="pre">minikube</span></code>, it should have configured your kubectl to point to the local minikube cluster by default.</p>
<p>You should be able to see this if you run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get all
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
service/kubernetes   ClusterIP   <span class="m">10</span>.96.0.1    &lt;none&gt;        <span class="m">443</span>/TCP   45h
</pre></div>
</div>
<ul class="simple">
<li><p><strong>k8s Namespaces</strong></p></li>
</ul>
<p>To understand the usage of <code class="docutils literal notranslate"><span class="pre">k8s</span> <span class="pre">Namespaces</span></code>, think of a namespace as a grouping of resources and permissions which lets you easily create and destroy everything related to a single keyword.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get namespaces
NAME                   STATUS   AGE
default                Active   45h
kube-node-lease        Active   45h
kube-public            Active   45h
kube-system            Active   45h
kubernetes-dashboard   Active   45h
</pre></div>
</div>
<p>All k8s have a default namespace and the other ones here are from kubernetes and minikube.</p>
<p>We will use the namespace <code class="docutils literal notranslate"><span class="pre">openmined</span></code> to make it clear what belongs to the Grid stack and what is something else. To create it, we can run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl create namespace openmined
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get all -n openmined
No resources found <span class="k">in</span> openmined namespace.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Kubectx</strong></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">kubectx</span></code> is a package of helpful utilities which can help you do things like set a default namespace.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ brew install kubectx
</pre></div>
</div>
<p>Now we can use a tool like <code class="docutils literal notranslate"><span class="pre">kubens</span></code> to change the default namespace to openmined.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubens openmined
Context <span class="s2">&quot;minikube&quot;</span> modified.
Active namespace is <span class="s2">&quot;openmined&quot;</span>.
</pre></div>
</div>
<p>Now when we use commands without <cite>-n</cite> we get openmined by default.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get all
No resources found <span class="k">in</span> openmined namespace.
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Helm Charts</strong></p></li>
</ul>
<p>The most popular way to deploy applications to k8s is with a tool called Helm. What helm aims to do is to provide another layer of abstraction over kubernetes yaml configuration with hierarchical variables, templates and a package definition which can be hosted over HTTP allowing custom applications to depend on other prefabricated helm charts or to provide consumable packages of your code as a helm chart itself.</p>
<ul class="simple">
<li><p><strong>devspace</strong></p></li>
</ul>
<p>To make development and deployment of our kubernetes code easier, we use a tool called <code class="docutils literal notranslate"><span class="pre">devspace</span></code> which aims to be like a hot reloading dev optimised version of <cite>docker compose</cite> but for kubernetes. More documentation can be <a class="reference external" href="https://devspace.sh/">found here</a>.</p>
<p>Additionally <code class="docutils literal notranslate"><span class="pre">devspace</span></code> allows us to deploy using helm by auto-generating the values and charts from the <code class="docutils literal notranslate"><span class="pre">devspace.yaml</span></code> which means the single source of truth can be created which includes both production helm charts and kubernetes yaml configuration as well as local dev overrides.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ brew install devspace
</pre></div>
</div>
</section>
<section id="deploy-to-local-dev">
<h3>Deploy to local dev<a class="headerlink" href="#deploy-to-local-dev" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Check that you have the right namespace:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace list namespaces
Name                   Default   Exists
default                <span class="nb">false</span>     <span class="nb">true</span>
kube-node-lease        <span class="nb">false</span>     <span class="nb">true</span>
kube-public            <span class="nb">false</span>     <span class="nb">true</span>
kube-system            <span class="nb">false</span>     <span class="nb">true</span>
kubernetes-dashboard   <span class="nb">false</span>     <span class="nb">true</span>
openmined              *true*      <span class="nb">true</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">dev</span></code> command with <code class="docutils literal notranslate"><span class="pre">devspace</span></code>:</p></li>
</ol>
<ul class="simple">
<li><p>To run a network with headscale VPN:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> packages/grid
$ devspace dev -b -p network
</pre></div>
</div>
<ul class="simple">
<li><p>To run a domain without the headscale VPN:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> packages/grid
$ devspace dev -b -p domain
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Connect VPN in dev:</p></li>
</ol>
<p>You can run the connect VPN settings using all the opened ports with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> packages/grid
$ python3 vpn/connect_vpn.py http://localhost:8088 http://localhost:8087 http://headscale:8080
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Destroy the local deployment</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace purge
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>Delete persistent volumes</p></li>
</ol>
<p>The database and the VPN containers have persistent volumes.</p>
<ul class="simple">
<li><p>You can check them with:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get persistentvolumeclaim
</pre></div>
</div>
<ul class="simple">
<li><p>Then delete PostgreSQL as it follows:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl delete persistentvolumeclaim app-db-data-db-0
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Check which images / tags are being used</p></li>
</ol>
<p>This will show all the unique images and their tags currently deployed which is useful
when debugging which version is actually running in the cluster.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods --all-namespaces -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.items[*].spec.containers[*].image}&quot;</span> <span class="p">|</span> tr -s <span class="s1">&#39;[[:space:]]&#39;</span> <span class="s1">&#39;\n&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Restart a container / pod / deployment</p></li>
</ol>
<ul class="simple">
<li><p>To get all the deployments:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get deployments
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
backend          <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           18m
backend-stream   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           18m
backend-worker   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           18m
frontend         <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           18m
queue            <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           19m
</pre></div>
</div>
<ul class="simple">
<li><p>Restart the backend-worker</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl rollout restart deployment backend-worker
</pre></div>
</div>
</section>
<section id="deploy-to-google-kubernetes-engine-gke">
<h3>Deploy to Google Kubernetes Engine (GKE)<a class="headerlink" href="#deploy-to-google-kubernetes-engine-gke" title="Permalink to this headline">¶</a></h3>
<p>1.Configure kubectl context with GKE:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ gcloud container clusters get-credentials --region us-central1-c staging-cluster-1
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Check that you have the correct context</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectx
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Configure your Google Container Registry (GCR):</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ gcloud auth configure-docker
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Check your settings with print</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace print -p domain --var<span class="o">=</span><span class="nv">CONTAINER_REGISTRY</span><span class="o">=</span>gcr.io/reflected-space-315806/
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>You should see that you are creating a domain and that the container registry variable changes the image name to:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>images:
     backend:
     image: gcr.io/reflected-space-315806/openmined/grid-backend
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This will tell <code class="docutils literal notranslate"><span class="pre">devspace</span></code> to publish to the GCR for your active GCP project.</p>
</div>
<ol class="arabic simple" start="6">
<li><p>Create the openmined namespace</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl create namespace openmined
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>Tell devspace to use the openmined namespace</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace use namespace openmined
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>Deploy to GKE:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace deploy -p domain --var<span class="o">=</span><span class="nv">CONTAINER_REGISTRY</span><span class="o">=</span>gcr.io/reflected-space-315806/
</pre></div>
</div>
<ol class="arabic simple" start="9">
<li><p>Access a container directly:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace enter
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>Attach to container stdout:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ devspace attach
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li><p>Use port forwarding to access an internal service:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl port-forward deployment/tailscale :4000
</pre></div>
</div>
</section>
</section>
<section id="deploying-to-azure">
<h2>Deploying to Azure<a class="headerlink" href="#deploying-to-azure" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Get your virtual machine on Azure ready</p>
<ol class="loweralpha">
<li><p>To create one, you can either go to <a class="reference external" href="http://portal.azure.com">portal.azure.com</a> or use <a class="reference external" href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FOpenMined%2FPySyft%2Fdev%2Fpackages%2Fgrid%2Fquickstart%2Ftemplate.json">this 1-click template</a> available off-the-shelves.</p></li>
<li><p>If you proceed to create it yourself, make sure you respect the following:</p>
<ol class="lowerroman simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">Ubuntu</span> <span class="pre">Server</span> <span class="pre">20.04</span></code> or newer</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">SSH</span></code>, <code class="docutils literal notranslate"><span class="pre">HTTP</span></code>, <code class="docutils literal notranslate"><span class="pre">HTTPS</span></code> as inbound ports</p></li>
<li><p>Have at least <code class="docutils literal notranslate"><span class="pre">2x</span> <span class="pre">CPU</span></code>, <code class="docutils literal notranslate"><span class="pre">4GB</span> <span class="pre">RAM</span></code>, <code class="docutils literal notranslate"><span class="pre">40GB</span> <span class="pre">HDD</span></code>.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>During creation, write down the username used and save the key locally. In case warnings arise regarding having an unprotected key, you can run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo chmod <span class="m">600</span> key.pem
</pre></div>
</div>
</div>
</li>
</ol>
</li>
<li><p>To deploy to Azure, the following can be run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ hagrid launch node --username<span class="o">=</span>azureuser --key_path<span class="o">=</span>~/hagriddeploy_key.pem domain to <span class="m">51</span>.124.153.133
</pre></div>
</div>
<p>Additionally, you are being asked if you want to provide another repository and branch to fetch and update HAGrid, which you can skip by pressing <code class="docutils literal notranslate"><span class="pre">Enter</span></code>.</p>
</li>
<li><p>If successful, you can now access the deployed node at the specified IP address and interact with it via the PyGrid Admin UI at <a class="reference external" href="http://51.124.153.133/login">http://51.124.153.133/login</a> (change IP with yours) or use Postman to do API requests.</p></li>
</ol>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Openmined Community.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>